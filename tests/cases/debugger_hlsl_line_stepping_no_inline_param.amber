#!amber
# Copyright 2020 The Amber Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https:#www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

SET ENGINE_DATA fence_timeout_ms 1000000

SHADER vertex vtex_shader SPIRV-ASM
; SPIR-V
; Version: 1.0
; Generator: Khronos SPIR-V Tools Assembler; 0
; Bound: 90
; Schema: 0
               OpCapability Shader
          %1 = OpExtInstImport "OpenCL.DebugInfo.100"
               OpMemoryModel Logical GLSL450
               OpEntryPoint Vertex %main "main" %in_var_POSITION %in_var_COLOR %gl_Position %out_var_COLOR
          %7 = OpString "vs.hlsl"
               OpSource HLSL 600 %7 "#line 1 \"vs.hlsl\"
struct VS_OUTPUT {
  float4 pos : SV_POSITION;
  float4 color : COLOR;
};

VS_OUTPUT main(float4 pos : POSITION,
               float4 color : COLOR) {
  VS_OUTPUT vout;
  vout.pos = pos;
  vout.color = color;
  return vout;
}
"
          %8 = OpString "#line 1 \"vs.hlsl\"
struct VS_OUTPUT {
  float4 pos : SV_POSITION;
  float4 color : COLOR;
};

VS_OUTPUT main(float4 pos : POSITION,
               float4 color : COLOR) {
  VS_OUTPUT vout;
  vout.pos = pos;
  vout.color = color;
  return vout;
}
"
          %9 = OpString "VS_OUTPUT"
         %10 = OpString "float"
         %11 = OpString "src.main"
         %12 = OpString "pos"
         %13 = OpString "color"
         %14 = OpString "vout"
               OpName %in_var_POSITION "in.var.POSITION"
               OpName %in_var_COLOR "in.var.COLOR"
               OpName %out_var_COLOR "out.var.COLOR"
               OpName %main "main"
               OpName %param_var_pos "param.var.pos"
               OpName %param_var_color "param.var.color"
               OpName %VS_OUTPUT "VS_OUTPUT"
               OpMemberName %VS_OUTPUT 0 "pos"
               OpMemberName %VS_OUTPUT 1 "color"
               OpDecorate %gl_Position BuiltIn Position
               OpDecorate %in_var_POSITION Location 0
               OpDecorate %in_var_COLOR Location 1
               OpDecorate %out_var_COLOR Location 0
        %int = OpTypeInt 32 1
      %int_0 = OpConstant %int 0
      %int_1 = OpConstant %int 1
       %uint = OpTypeInt 32 0
    %uint_32 = OpConstant %uint 32
      %float = OpTypeFloat 32
    %v4float = OpTypeVector %float 4
%_ptr_Input_v4float = OpTypePointer Input %v4float
%_ptr_Output_v4float = OpTypePointer Output %v4float
       %void = OpTypeVoid
   %uint_256 = OpConstant %uint 256
     %uint_0 = OpConstant %uint 0
   %uint_128 = OpConstant %uint 128
         %36 = OpTypeFunction %void
%_ptr_Function_v4float = OpTypePointer Function %v4float
  %VS_OUTPUT = OpTypeStruct %v4float %v4float
         %38 = OpTypeFunction %VS_OUTPUT %_ptr_Function_v4float %_ptr_Function_v4float
%_ptr_Function_VS_OUTPUT = OpTypePointer Function %VS_OUTPUT
               OpLine %7 6 29
%in_var_POSITION = OpVariable %_ptr_Input_v4float Input
               OpLine %7 7 31
%in_var_COLOR = OpVariable %_ptr_Input_v4float Input
               OpLine %7 2 16
%gl_Position = OpVariable %_ptr_Output_v4float Output
               OpLine %7 3 18
%out_var_COLOR = OpVariable %_ptr_Output_v4float Output
         %none = OpExtInst %void %1 DebugInfoNone
         %40 = OpExtInst %void %1 DebugExpression
         %41 = OpExtInst %void %1 DebugSource %7 %8
         %42 = OpExtInst %void %1 DebugCompilationUnit 1 4 %41 HLSL
         %43 = OpExtInst %void %1 DebugTypeComposite %9 Structure %41 1 1 %42 %9 %uint_256 FlagIsProtected|FlagIsPrivate %44 %45
         %46 = OpExtInst %void %1 DebugTypeBasic %10 %uint_32 Float
         %47 = OpExtInst %void %1 DebugTypeVector %46 4
         %48 = OpExtInst %void %1 DebugTypeFunction FlagIsProtected|FlagIsPrivate %43 %47 %47
         %49 = OpExtInst %void %1 DebugFunction %11 %48 %41 6 1 %42 %11 FlagIsProtected|FlagIsPrivate 7 %none
         %50 = OpExtInst %void %1 DebugLocalVariable %12 %47 %41 6 23 %49 FlagIsLocal 0
         %51 = OpExtInst %void %1 DebugLocalVariable %13 %47 %41 7 23 %49 FlagIsLocal 1
         %52 = OpExtInst %void %1 DebugLexicalBlock %41 7 38 %49
         %53 = OpExtInst %void %1 DebugLocalVariable %14 %43 %41 8 13 %52 FlagIsLocal
         %44 = OpExtInst %void %1 DebugTypeMember %12 %47 %41 2 3 %43 %uint_0 %uint_128 FlagIsProtected|FlagIsPrivate
         %45 = OpExtInst %void %1 DebugTypeMember %13 %47 %41 3 3 %43 %uint_128 %uint_128 FlagIsProtected|FlagIsPrivate
               OpLine %7 6 1
       %main = OpFunction %void None %36
         %54 = OpLabel
         %79 = OpExtInst %void %1 DebugScope %52
               OpLine %7 8 13
         %71 = OpVariable %_ptr_Function_VS_OUTPUT Function
         %65 = OpExtInst %void %1 DebugDeclare %53 %71 %40
         %80 = OpExtInst %void %1 DebugScope %49
         %72 = OpVariable %_ptr_Function_VS_OUTPUT Function
         %81 = OpExtInst %void %1 DebugScope %42
               OpLine %7 6 23
%param_var_pos = OpVariable %_ptr_Function_v4float Function
         %62 = OpExtInst %void %1 DebugDeclare %50 %param_var_pos %40
               OpLine %7 7 23
%param_var_color = OpVariable %_ptr_Function_v4float Function
         %63 = OpExtInst %void %1 DebugDeclare %51 %param_var_color %40
               OpLine %7 6 23
         %56 = OpLoad %v4float %in_var_POSITION
               OpStore %param_var_pos %56
               OpLine %7 7 23
         %57 = OpLoad %v4float %in_var_COLOR
               OpStore %param_var_color %57
         %82 = OpExtInst %void %1 DebugScope %52
               OpLine %7 9 14
         %73 = OpLoad %v4float %param_var_pos
               OpLine %7 9 3
         %74 = OpAccessChain %_ptr_Function_v4float %71 %int_0
               OpStore %74 %73
               OpLine %7 10 16
         %75 = OpLoad %v4float %param_var_color
               OpLine %7 10 3
         %76 = OpAccessChain %_ptr_Function_v4float %71 %int_1
               OpStore %76 %75
               OpLine %7 11 10
         %77 = OpLoad %VS_OUTPUT %71
         %83 = OpExtInst %void %1 DebugScope %49
               OpStore %72 %77
         %58 = OpLoad %VS_OUTPUT %72
         %84 = OpExtInst %void %1 DebugScope %42
               OpLine %7 6 11
         %59 = OpCompositeExtract %v4float %58 0
               OpLine %7 2 16
               OpStore %gl_Position %59
               OpLine %7 6 11
         %60 = OpCompositeExtract %v4float %58 1
               OpLine %7 3 18
               OpStore %out_var_COLOR %60
         %85 = OpExtInst %void %1 DebugNoScope
               OpReturn
               OpFunctionEnd
               OpLine %7 6 1
END

SHADER fragment frag_shader SPIRV-ASM
; SPIR-V
; Version: 1.0
; Generator: Khronos SPIR-V Tools Assembler; 0
; Bound: 54
; Schema: 0
               OpCapability Shader
          %1 = OpExtInstImport "OpenCL.DebugInfo.100"
               OpMemoryModel Logical GLSL450
               OpEntryPoint Fragment %main "main" %in_var_COLOR %out_var_SV_TARGET
               OpExecutionMode %main OriginUpperLeft
          %5 = OpString "ps.hlsl"
               OpSource HLSL 600 %5 "#line 1 \"ps.hlsl\"
float4 main(float4 color : COLOR) : SV_TARGET {
  return color;
}
"
          %6 = OpString "#line 1 \"ps.hlsl\"
float4 main(float4 color : COLOR) : SV_TARGET {
  return color;
}
"
          %7 = OpString "float"
          %8 = OpString "src.main"
          %9 = OpString "color"
               OpName %in_var_COLOR "in.var.COLOR"
               OpName %out_var_SV_TARGET "out.var.SV_TARGET"
               OpName %main "main"
               OpName %param_var_color "param.var.color"
               OpDecorate %in_var_COLOR Location 0
               OpDecorate %out_var_SV_TARGET Location 0
       %uint = OpTypeInt 32 0
    %uint_32 = OpConstant %uint 32
      %float = OpTypeFloat 32
    %v4float = OpTypeVector %float 4
%_ptr_Input_v4float = OpTypePointer Input %v4float
%_ptr_Output_v4float = OpTypePointer Output %v4float
       %void = OpTypeVoid
         %21 = OpTypeFunction %void
%_ptr_Function_v4float = OpTypePointer Function %v4float
         %23 = OpTypeFunction %v4float %_ptr_Function_v4float
               OpLine %5 1 28
%in_var_COLOR = OpVariable %_ptr_Input_v4float Input
               OpLine %5 1 37
%out_var_SV_TARGET = OpVariable %_ptr_Output_v4float Output
         %none = OpExtInst %void %1 DebugInfoNone
         %24 = OpExtInst %void %1 DebugExpression
         %25 = OpExtInst %void %1 DebugSource %5 %6
         %26 = OpExtInst %void %1 DebugCompilationUnit 1 4 %25 HLSL
         %27 = OpExtInst %void %1 DebugTypeBasic %7 %uint_32 Float
         %28 = OpExtInst %void %1 DebugTypeVector %27 4
         %29 = OpExtInst %void %1 DebugTypeFunction FlagIsProtected|FlagIsPrivate %28 %28
         %30 = OpExtInst %void %1 DebugFunction %8 %29 %25 1 1 %26 %8 FlagIsProtected|FlagIsPrivate 1 %none
         %31 = OpExtInst %void %1 DebugLocalVariable %9 %28 %25 1 20 %30 FlagIsLocal 0
         %32 = OpExtInst %void %1 DebugLexicalBlock %25 1 47 %30
               OpLine %5 1 1
       %main = OpFunction %void None %21
         %33 = OpLabel
         %44 = OpExtInst %void %1 DebugScope %30
         %41 = OpVariable %_ptr_Function_v4float Function
         %45 = OpExtInst %void %1 DebugScope %26
               OpLine %5 1 20
%param_var_color = OpVariable %_ptr_Function_v4float Function
         %38 = OpExtInst %void %1 DebugDeclare %31 %param_var_color %24
         %35 = OpLoad %v4float %in_var_COLOR
               OpStore %param_var_color %35
         %46 = OpExtInst %void %1 DebugScope %32
               OpLine %5 2 10
         %42 = OpLoad %v4float %param_var_color
         %47 = OpExtInst %void %1 DebugScope %30
               OpStore %41 %42
         %36 = OpLoad %v4float %41
         %48 = OpExtInst %void %1 DebugScope %26
               OpLine %5 1 37
               OpStore %out_var_SV_TARGET %36
         %49 = OpExtInst %void %1 DebugNoScope
               OpReturn
               OpFunctionEnd
               OpLine %5 1 1
END

BUFFER position_buf DATA_TYPE R8G8_SNORM DATA
# Full frame
-128 -128
 127  127
-128  127
-128 -128
 127  127
 127 -128
END

BUFFER vert_color DATA_TYPE R8G8B8A8_UNORM DATA
255   0   0 255
255   0   0 255
255   0   0 255
255   0   0 255
255   0   0 255
255   0   0 255

  0 255   0 255
  0 255   0 255
  0 255   0 255
  0 255   0 255
  0 255   0 255
  0 255   0 255

  0   0 255 255
  0   0 255 255
  0   0 255 255
  0   0 255 255
  0   0 255 255
  0   0 255 255

127 127 127 255
127 127 127 255
127 127 127 255
127 127 127 255
127 127 127 255
127 127 127 255
END

BUFFER framebuffer FORMAT B8G8R8A8_UNORM

PIPELINE graphics pipeline
  ATTACH vtex_shader
  ATTACH frag_shader

  VERTEX_DATA position_buf LOCATION 0
  VERTEX_DATA vert_color LOCATION 1

  BIND BUFFER framebuffer AS color LOCATION 0
END

CLEAR pipeline

DEBUG pipeline DRAW_ARRAY AS TRIANGLE_LIST START_IDX 0 COUNT 6
    THREAD VERTEX_INDEX 2
        EXPECT LOCATION "simple_vs.hlsl" 9 "  VS_OUTPUT vout;"
        EXPECT LOCAL "pos.x" EQ -1.007874
        EXPECT LOCAL "pos.y" EQ 1.000000
        EXPECT LOCAL "pos.z" EQ 0.000000
        EXPECT LOCAL "color.x" EQ 1.000000
        EXPECT LOCAL "color.y" EQ 0.000000
        EXPECT LOCAL "color.z" EQ 0.000000
        STEP_IN
        EXPECT LOCATION "simple_vs.hlsl" 10 "  vout.pos = pos;"
        STEP_IN
        EXPECT LOCAL "vout.pos.x" EQ -1.007874
        EXPECT LOCAL "vout.pos.y" EQ 1.000000
        EXPECT LOCAL "vout.pos.z" EQ 0.000000
        EXPECT LOCATION "simple_vs.hlsl" 11 "  vout.color = color;"
        STEP_IN
        EXPECT LOCAL "vout.color.x" EQ 1.000000
        EXPECT LOCAL "vout.color.y" EQ 0.000000
        EXPECT LOCAL "vout.color.z" EQ 0.000000
        EXPECT LOCATION "simple_vs.hlsl" 12 "  return vout;"
        CONTINUE
    END
END

EXPECT framebuffer IDX 0 0 SIZE 250 250 EQ_RGB 255 0 0
